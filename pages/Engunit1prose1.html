<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sea Turtles - Interactive Learning</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lottie Animation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.7.14/lottie.min.js"></script>
    
    <style>
        /* Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: #f5f5f5;
        }

        /* Level Container */
        .level-container {
            max-width: 1000px;
            margin: 20px auto;
            padding: 20px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        /* Level Header */
        .level-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 30px;
            padding: 15px;
            background: #FF9B3F;
            border-radius: 10px;
            color: white;
        }

        .level-number {
            font-size: 2rem;
            font-weight: bold;
        }

        .level-title {
            font-size: 1.5rem;
        }

        /* Content Area */
        .content-area {
            padding: 20px;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.5s ease;
        }

        .content-area.visible {
            opacity: 1;
            transform: translateY(0);
        }

        /* Interactive Word */
        .interactive-word {
            color: #FF9B3F;
            cursor: pointer;
            position: relative;
            padding: 0 4px;
            transition: all 0.3s ease;
            font-size: 2.5rem !important;
        }

        .interactive-word:hover {
            background: #fff3e6;
            border-radius: 4px;
        }

        .tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 12px 18px;
            border-radius: 6px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            font-size: 1.5rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 100;
        }

        .interactive-word:hover .tooltip {
            opacity: 1;
            visibility: visible;
        }

        /* Navigation Button */
        .nav-button {
            background: #FF9B3F;
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 20px auto;
            transition: all 0.3s ease;
        }

        .nav-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 155, 63, 0.3);
        }

        .turtle-container {
            width: 200px;
            height: 200px;
            position: relative;
            animation: float 3s ease-in-out infinite;
            transform-style: preserve-3d;
            perspective: 1000px;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            25% { transform: translateY(-10px) rotate(2deg); }
            75% { transform: translateY(5px) rotate(-2deg); }
        }

        .turtle {
            width: 140px;
            height: 90px;
            background: linear-gradient(145deg, #2E8B57, #3CB371);
            border-radius: 60% 60% 60% 60% / 70% 70% 50% 50%;
            position: relative;
            margin: 40px auto;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transform-style: preserve-3d;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .turtle::before {  /* Head */
            content: '';
            position: absolute;
            width: 35px;
            height: 30px;
            background: linear-gradient(145deg, #2E8B57, #3CB371);
            border-radius: 60% 50% 50% 50%;
            left: -20px;
            top: 30px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .turtle::after {  /* Tail */
            content: '';
            position: absolute;
            width: 25px;
            height: 20px;
            background: linear-gradient(145deg, #2E8B57, #3CB371);
            border-radius: 50% 50% 50% 60%;
            right: -15px;
            top: 35px;
        }

        .flipper {
            position: absolute;
            width: 50px;
            height: 20px;
            background: linear-gradient(145deg, #2E8B57, #3CB371);
            border-radius: 60% 40% 40% 60%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .flipper-front {
            left: 15px;
            top: 20px;
            transform-origin: left center;
            animation: swim-front 2s ease-in-out infinite;
        }

        .flipper-back {
            right: 15px;
            top: 20px;
            transform-origin: right center;
            animation: swim-back 2s ease-in-out infinite;
        }

        @keyframes swim-front {
            0%, 100% { transform: rotate(-20deg) translateY(0); }
            50% { transform: rotate(30deg) translateY(-5px); }
        }

        @keyframes swim-back {
            0%, 100% { transform: rotate(20deg) translateY(0); }
            50% { transform: rotate(-30deg) translateY(-5px); }
        }

        .shell-pattern {
            position: absolute;
            width: 100px;
            height: 65px;
            border: 3px solid rgba(255,255,255,0.2);
            border-radius: 50%;
            top: 12px;
            left: 20px;
            transform: rotate(-5deg);
        }

        .shell-pattern::before {
            content: '';
            position: absolute;
            width: 80px;
            height: 50px;
            border: 2px solid rgba(255,255,255,0.15);
            border-radius: 50%;
            top: 5px;
            left: 8px;
        }

        .shell-pattern::after {
            content: '';
            position: absolute;
            width: 60px;
            height: 35px;
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 50%;
            top: 12px;
            left: 18px;
        }

        .eye {
            position: absolute;
            width: 8px;
            height: 8px;
            background: #000;
            border-radius: 50%;
            left: -12px;
            top: 35px;
            box-shadow: 0 0 0 2px rgba(255,255,255,0.6);
        }

        .bubbles {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .bubble {
            position: absolute;
            background: rgba(255,255,255,0.4);
            border-radius: 50%;
            animation: bubble-rise 3s ease-out infinite;
        }

        @keyframes bubble-rise {
            0% { 
                transform: translateY(0) scale(0.1); 
                opacity: 0; 
            }
            20% { opacity: 0.8; }
            100% { 
                transform: translateY(-100px) scale(1.5); 
                opacity: 0; 
            }
        }

        /* Water Effect */
        .water-container {
            position: relative;
            width: 100%;
            height: 200px;
            overflow: hidden;
            border-radius: 10px;
            background: linear-gradient(180deg, #a8e6ff 0%, #4db6e5 100%);
            margin-bottom: 20px;
        }

        .ripple {
            position: absolute;
            border: 2px solid rgba(255, 255, 255, 0.4);
            border-radius: 50%;
            animation: ripple 3s linear infinite;
            pointer-events: none;
        }

        @keyframes ripple {
            0% { width: 0; height: 0; opacity: 0.8; }
            100% { width: 100px; height: 100px; opacity: 0; }
        }

        /* Enhanced Turtle Animation */
        .turtle.swimming-fast {
            animation: swim-fast 1.5s ease-in-out infinite;
        }

        .turtle.diving {
            animation: dive 2s ease-in-out;
        }

        @keyframes swim-fast {
            0%, 100% { transform: translateX(0) rotate(0deg); }
            25% { transform: translateX(10px) rotate(5deg); }
            75% { transform: translateX(-10px) rotate(-5deg); }
        }

        @keyframes dive {
            0% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(50px) rotate(45deg) scale(0.8); }
            100% { transform: translateY(0) rotate(0deg); }
        }

        /* Water Surface */
        .water-surface {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 20px;
            background: linear-gradient(180deg, rgba(255,255,255,0.4) 0%, transparent 100%);
            animation: surface-move 3s ease-in-out infinite;
        }

        @keyframes surface-move {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(5px); }
        }

        /* Particle Effects */
        .particle {
            position: absolute;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 50%;
            pointer-events: none;
            z-index: 1;
        }

        /* Sound Controls */
        .controls-panel {
            position: fixed;
            bottom: 20px;
            left: 20px;
            display: flex;
            gap: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        .control-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: #FF9B3F;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .control-btn:hover {
            transform: scale(1.1);
        }

        .control-btn.active {
            background: #2E8B57;
        }

        /* Read Aloud Highlight */
        .reading-highlight {
            background: none;
        }

        /* Mobile Improvements */
        @media (max-width: 768px) {
            .level-container {
                margin: 10px;
                padding: 15px;
            }

            .controls-panel {
                bottom: 10px;
                left: 50%;
                transform: translateX(-50%);
                flex-wrap: wrap;
                justify-content: center;
            }

            .water-container {
                height: 150px;
            }

            .turtle {
                transform: scale(0.8);
            }

            .flex {
                flex-direction: column;
            }
        }
        
        /* Update these styles */
        .text-lg {
            line-height: 1.6;
            position: relative;
            font-size: 2.5rem !important;
            color: #333;
            margin-bottom: 1.5rem;
        }

        .word {
            display: inline;
            padding: 2px;
            border-radius: 3px;
            transition: all 0.3s ease;
        }

        .word.active {
            background: #FF9B3F;
            color: white;
            padding: 2px 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border-radius: 4px;
        }

        /* Special handling for interactive words */
        .interactive-word .word.active {
            background: #2E8B57;
        }

        /* Remove old styles that might conflict */
        .highlight-word,
        .current-word {
            display: none;
        }

        /* New styles */
        .sound-on, .sound-off {
            transition: all 0.3s ease;
        }

        .control-btn.muted .sound-on {
            display: none;
        }

        .control-btn.muted .sound-off {
            display: block;
        }

        .control-btn.muted {
            background: #ff6b6b;
        }

        .control-btn.active {
            background: #2E8B57;
        }

        /* Add these styles for the image container */
        .image-container {
            overflow: hidden;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .image-container img {
            display: block;
            width: 100%;
            height: auto;
            transition: transform 0.3s ease;
        }

        .image-container:hover img {
            transform: scale(1.05);
        }
    </style>
</head>
<body>
    <div class="level-container">
        <div class="level-header">
            <div class="level-number">1</div>
            <div class="level-title">Introduction to Sea Turtles</div>
        </div>

        <div class="content-area" id="contentArea">
            <div class="flex gap-8">
                <div class="flex-1">
                    <p class="text-lg leading-relaxed mb-4">
                        Most of us have seen a 
                        <span class="interactive-word">
                            tortoise
                            <span class="tooltip">A land-dwelling reptile with a hard shell</span>
                        </span>
                        in a zoo or a reptile park. However, not many would have seen its 
                        <span class="interactive-word">
                            marine
                            <span class="tooltip">Related to or found in the sea</span>
                        </span>
                        relative, the sea turtle. This is not surprising, since these reptiles spend almost their entire life in the sea.
                    </p>
                </div>
                <div class="w-1/3">
                    <div id="turtleAnimation"></div>
                </div>
            </div>

            <button class="nav-button" onclick="completeLevel()">
                I'm Ready to Learn More!
                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"/>
                </svg>
            </button>
        </div>
    </div>

    <script>
        // Replace the sounds initialization with this error-handled version
        const sounds = {
            splash: null,
            bubble: null,
            swim: null
        };

        // Try to load sounds with error handling
        try {
            sounds.splash = new Audio('/sounds/splash.mp3');
            sounds.bubble = new Audio('/sounds/bubble.mp3');
            sounds.swim = new Audio('/sounds/swim.mp3');
            
            // Initialize volume if sounds loaded successfully
            Object.values(sounds).forEach(sound => {
                if (sound) sound.volume = 0.3;
            });
        } catch (error) {
            console.log('Sound effects not available');
        }

        // Update the sound playing functions to check if sound exists
        function playSound(soundName) {
            if (sounds[soundName]) {
                sounds[soundName].currentTime = 0;
                sounds[soundName].play().catch(err => console.log('Sound playback failed'));
            }
        }

        // Update the turtleHTML constant
        const turtleHTML = `
            <div class="water-container">
                <div class="water-surface"></div>
                <div class="turtle-container">
                    <div class="bubbles">
                        ${Array.from({length: 8}, (_, i) => `
                            <div class="bubble" style="
                                width: ${Math.random() * 10 + 5}px;
                                height: ${Math.random() * 10 + 5}px;
                                left: ${Math.random() * 100}%;
                                animation-delay: ${Math.random() * 2}s;
                            "></div>
                        `).join('')}
                    </div>
                    <div class="turtle" id="interactiveTurtle">
                        <div class="eye"></div>
                        <div class="flipper flipper-front"></div>
                        <div class="flipper flipper-back"></div>
                        <div class="shell-pattern"></div>
                    </div>
                </div>
            </div>
        `;

        // Add this before the DOMContentLoaded event listener
        const newStyles = `
            .sound-on, .sound-off {
                transition: all 0.3s ease;
            }

            .control-btn.muted .sound-on {
                display: none;
            }

            .control-btn.muted .sound-off {
                display: block;
            }

            .control-btn.muted {
                background: #ff6b6b;
            }

            .control-btn.active {
                background: #2E8B57;
            }
        `;

        // Update the DOMContentLoaded event listener
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize speech and controls
            const speechManager = new SpeechManager();
            document.body.insertAdjacentHTML('beforeend', controlsHTML);

            // Add the new styles
            const styleSheet = document.createElement('style');
            styleSheet.textContent = newStyles;
            document.head.appendChild(styleSheet);

            // Initialize sound state
            let isMuted = false;

            // Sound toggle button with improved functionality
            const soundToggle = document.getElementById('soundToggle');
            soundToggle.addEventListener('click', () => {
                isMuted = !isMuted;
                
                // Update button appearance
                soundToggle.classList.toggle('muted', isMuted);
                
                // Update all audio elements
                Object.values(sounds).forEach(sound => {
                    if (sound) {
                        sound.muted = isMuted;
                    }
                });

                // Update speech synthesis
                if (isMuted) {
                    window.speechSynthesis.cancel();
                }

                // Store preference
                localStorage.setItem('soundMuted', isMuted);
            });

            // Load saved preference
            const savedMuted = localStorage.getItem('soundMuted') === 'true';
            if (savedMuted) {
                isMuted = true;
                soundToggle.classList.add('muted');
                Object.values(sounds).forEach(sound => {
                    if (sound) sound.muted = true;
                });
            }

            // Read aloud button
            const readAloud = document.getElementById('readAloud');
            readAloud.addEventListener('click', () => {
                readAloud.classList.toggle('active');
                document.querySelector('.text-lg').classList.toggle('reading-highlight');
                
                // If already speaking, this will stop it
                if (speechManager.speaking) {
                    readAloud.classList.remove('active');
                    document.querySelector('.text-lg').classList.remove('reading-highlight');
                    window.speechSynthesis.cancel();
                    speechManager.speaking = false;
                    return;
                }
                
                speechManager.speak();
            });

            // Replace the animation container content
            document.getElementById('turtleAnimation').innerHTML = turtleHTML;

            // Show content with animation
            setTimeout(() => {
                document.getElementById('contentArea').classList.add('visible');
            }, 500);

            // Add turtle animations back
            const turtle = document.getElementById('interactiveTurtle');
            const container = document.querySelector('.water-container');
            let isSwimmingFast = false;
            let currentPattern = 0;
            const patterns = ['swimming-pattern-1', 'swimming-pattern-2', 'swimming-pattern-3'];

            // Cursor following
            container.addEventListener('mousemove', (e) => {
                const rect = container.getBoundingClientRect();
                const x = e.clientX - rect.left - turtle.offsetWidth / 2;
                const y = e.clientY - rect.top - turtle.offsetHeight / 2;

                // Keep turtle within container bounds
                const maxX = container.offsetWidth - turtle.offsetWidth;
                const maxY = container.offsetHeight - turtle.offsetHeight;
                const boundedX = Math.min(Math.max(0, x), maxX);
                const boundedY = Math.min(Math.max(0, y), maxY);

                turtle.style.transform = `translate(${boundedX}px, ${boundedY}px)`;
            });

            // Click to dive with sound
            turtle.addEventListener('click', () => {
                if (!turtle.classList.contains('diving')) {
                    playSound('splash');
                    turtle.classList.add('diving');
                    createRippleEffect(event);
                    setTimeout(() => {
                        turtle.classList.remove('diving');
                    }, 2000);
                }
            });

            // Double click to change swimming pattern
            turtle.addEventListener('dblclick', () => {
                // Remove current pattern
                patterns.forEach(pattern => turtle.classList.remove(pattern));
                
                // Add next pattern
                currentPattern = (currentPattern + 1) % patterns.length;
                turtle.classList.add(patterns[currentPattern]);
                
                playSound('swim');
                updateBubbleSpeed(currentPattern === 1); // Fast bubbles for pattern 1
            });

            // Create bubbles periodically
            setInterval(() => {
                if (Math.random() > 0.7) { // 30% chance to create bubble
                    createBubble(turtle.offsetLeft + turtle.offsetWidth / 2, 
                                turtle.offsetTop + turtle.offsetHeight / 2);
                    playSound('bubble');
                }
            }, 1000);
        });

        function createBubble(x, y) {
            const bubble = document.createElement('div');
            bubble.className = 'bubble';
            bubble.style.left = `${x}px`;
            bubble.style.top = `${y}px`;
            bubble.style.width = `${Math.random() * 10 + 5}px`;
            bubble.style.height = bubble.style.width;
            
            document.querySelector('.bubbles').appendChild(bubble);
            
            // Remove bubble after animation
            setTimeout(() => bubble.remove(), 3000);
        }

        function createRippleEffect(e) {
            const ripple = document.createElement('div');
            ripple.className = 'ripple';
            
            const rect = e.target.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            ripple.style.left = `${x}px`;
            ripple.style.top = `${y}px`;
            
            e.target.appendChild(ripple);
            setTimeout(() => ripple.remove(), 3000);
        }

        function updateBubbleSpeed(isFast) {
            const bubbles = document.querySelectorAll('.bubble');
            bubbles.forEach(bubble => {
                bubble.style.animationDuration = isFast ? '1.5s' : '3s';
            });
        }

        function completeLevel() {
            const contentArea = document.getElementById('contentArea');
            const levelContainer = document.querySelector('.level-container');
            const currentLevel = parseInt(levelContainer.querySelector('.level-number').textContent);
            
            // Fade out current content
            contentArea.style.opacity = '0';
            contentArea.style.transform = 'translateY(-20px)';
            
            // After fade out, update content based on current level
            setTimeout(() => {
                switch(currentLevel) {
                    case 1:
                        levelContainer.innerHTML = level2Content;
                        break;
                    case 2:
                        levelContainer.innerHTML = level3Content;
                        break;
                    // Add more cases for additional levels
                    default:
                        console.log('All levels completed!');
                        return;
                }

                const newContentArea = document.getElementById('contentArea');
                
                // Fade in new content
                setTimeout(() => {
                    newContentArea.style.opacity = '1';
                    newContentArea.style.transform = 'translateY(0)';
                    newContentArea.classList.add('visible');
                }, 100);
            }, 500);
        }

        // Update the level2Content to include the continue button
        const level2Content = `
            <div class="level-header">
                <div class="level-number">2</div>
                <div class="level-title">Sea Turtle Species</div>
            </div>

            <div class="content-area" id="contentArea">
                <div class="flex gap-8">
                    <div class="flex-1">
                        <p class="text-lg leading-relaxed mb-4" style="font-size: 2.5rem;">
                            There are seven species of marine or sea turtles in the world. Of them, five are found in India's coastal waters: the 
                            <span class="interactive-word">
                                Olive Ridley
                                <span class="tooltip">The smallest species of sea turtle</span>
                            </span>
                            , the Hawksbill, the Green Sea Turtle, the Loggerhead and the 
                            <span class="interactive-word">
                                Leatherback
                                <span class="tooltip">The largest species of sea turtle</span>
                            </span>
                            . Compared to most tortoises, sea turtles are huge. Even the smallest species, the Olive Ridley, weighs up to 35 kg when fully grown. The largest of them all, the Leatherback, grows to a length of 2.2m and each could weigh as much as 700 kg!
                        </p>
                    </div>
                    <div class="w-1/3">
                        <div class="image-container">
                            <img 
                                src="/img/sea-turtle-species.png" 
                                alt="Different Species of Sea Turtles"
                                class="rounded-lg shadow-lg hover:scale-105 transition-transform duration-300"
                            />
                        </div>
                    </div>
                </div>

                <button class="nav-button" onclick="completeLevel()">
                    Continue to Next Level
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"/>
                    </svg>
                </button>
            </div>
        `;

        // Add level 3 content
        const level3Content = `
            <div class="level-header">
                <div class="level-number">3</div>
                <div class="level-title">Sea Turtle Habitats</div>
            </div>

            <div class="content-area" id="contentArea">
                <div class="flex gap-8">
                    <div class="flex-1">
                        <p class="text-lg leading-relaxed mb-4" style="font-size: 2.5rem;">
                            Sea turtles live their life entirely in the 
                            <span class="interactive-word">
                                oceans
                                <span class="tooltip">Large bodies of saltwater that cover most of Earth's surface</span>
                            </span>
                            . But they still have a connection with land â€“ they must come ashore to lay eggs. Today, four of the sea turtle species mentioned above have become extremely rare in India. The Olive Ridleys, however, are still commonly seen 
                            <span class="interactive-word">
                                nesting
                                <span class="tooltip">Building nests and laying eggs</span>
                            </span>
                            on sandy beaches all along our coasts.
                        </p>
                    </div>
                    <div class="w-1/3">
                        <div class="image-container">
                            <img 
                                src="/img/sea-turtle-nesting.png" 
                                alt="Sea Turtle Nesting on Beach"
                                class="rounded-lg shadow-lg hover:scale-105 transition-transform duration-300"
                            />
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Update the SpeechManager class
        class SpeechManager {
            constructor() {
                this.synth = window.speechSynthesis;
                this.speaking = false;
            }

            speak(text) {
                if (this.speaking) {
                    this.synth.cancel();
                    this.speaking = false;
                    return;
                }

                const container = document.querySelector('.text-lg');
                const originalHTML = container.innerHTML;

                // First, remove tooltips from speech text
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = originalHTML;
                tempDiv.querySelectorAll('.tooltip').forEach(tooltip => tooltip.remove());
                const cleanText = tempDiv.textContent.trim();

                // Wrap words in spans while preserving interactive elements
                const wrapWords = (node) => {
                    if (node.nodeType === Node.TEXT_NODE) {
                        const words = node.textContent.trim().split(/\s+/);
                        if (words.length === 0) return node;

                        const fragment = document.createDocumentFragment();
                        words.forEach((word, i) => {
                            if (word) {
                                const span = document.createElement('span');
                                span.className = 'word';
                                span.textContent = word;
                                fragment.appendChild(span);
                                if (i < words.length - 1) {
                                    fragment.appendChild(document.createTextNode(' '));
                                }
                            }
                        });
                        return fragment;
                    }

                    if (node.nodeType === Node.ELEMENT_NODE) {
                        // Skip tooltip elements entirely
                        if (node.classList.contains('tooltip')) return null;
                        
                        const clone = node.cloneNode(false);
                        Array.from(node.childNodes).forEach(child => {
                            const processed = wrapWords(child);
                            if (processed) clone.appendChild(processed);
                        });
                        return clone;
                    }

                    return node;
                };

                // Process the content
                const processedContainer = container.cloneNode(false);
                Array.from(container.childNodes).forEach(child => {
                    const processed = wrapWords(child);
                    if (processed) processedContainer.appendChild(processed);
                });
                container.replaceWith(processedContainer);

                const utterance = new SpeechSynthesisUtterance(cleanText);
                utterance.rate = 0.9;
                utterance.pitch = 1;
                utterance.lang = 'en-US';

                const words = Array.from(processedContainer.querySelectorAll('.word'));
                let currentIndex = 0;

                utterance.onboundary = (event) => {
                    if (event.name === 'word' && words[currentIndex]) {
                        words.forEach(word => word.classList.remove('active'));
                        words[currentIndex].classList.add('active');
                        currentIndex++;
                    }
                };

                utterance.onend = () => {
                    this.speaking = false;
                    processedContainer.replaceWith(container);
                    container.innerHTML = originalHTML;
                };

                utterance.onerror = () => {
                    this.speaking = false;
                    processedContainer.replaceWith(container);
                    container.innerHTML = originalHTML;
                };

                this.speaking = true;
                this.synth.speak(utterance);
            }
        }

        // Update the sound toggle button HTML with mute icon
        const controlsHTML = `
            <div class="controls-panel">
                <button class="control-btn" id="soundToggle" title="Toggle Sound">
                    <svg class="sound-on" width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                            d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"/>
                    </svg>
                    <svg class="sound-off" width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="display: none;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                            d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15zM17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2"/>
                    </svg>
                </button>
                <button class="control-btn" id="readAloud" title="Read Aloud">
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                            d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0-11V3m0 0a7 7 0 017 7c0 1.462-.446 2.816-1.208 3.937"/>
                    </svg>
                </button>
            </div>
        `;
    </script>
</body>
</html> 
