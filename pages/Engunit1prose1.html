<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sea Turtles - Interactive Prose</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lottie Animation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.7.14/lottie.min.js"></script>
    
    <!-- Custom Styles -->
    <style>
        .highlight-word {
            color: #FF9B3F;
            cursor: pointer;
            position: relative;
            transition: all 0.3s ease;
        }

        .highlight-word:hover {
            background: #fff3e6;
            padding: 0 4px;
            border-radius: 4px;
        }

        .tooltip {
            visibility: hidden;
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 8px 12px;
            border-radius: 6px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            font-size: 0.9em;
            width: max-content;
            max-width: 200px;
            z-index: 100;
            opacity: 0;
            transition: all 0.3s ease;
        }

        .highlight-word:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #f0f0f0;
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #FF9B3F;
            width: 0%;
            transition: width 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease forwards;
        }

        .section-content {
            opacity: 0;
            transform: translateY(20px);
        }

        .section-content.visible {
            animation: fadeIn 0.5s ease forwards;
        }

        @keyframes celebrate {
            0% { transform: scale(0.8); opacity: 0; }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .quiz-feedback {
            animation: slideIn 0.5s ease forwards;
        }

        .score-display {
            animation: celebrate 0.8s ease forwards;
        }

        .feedback-icon {
            width: 100px;
            height: 100px;
            margin: 0 auto 20px;
        }

        .answer-feedback {
            padding: 10px;
            margin: 5px 0;
            border-radius: 8px;
            animation: slideIn 0.3s ease forwards;
        }

        .answer-feedback.correct {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.2);
        }

        .answer-feedback.incorrect {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        /* Loading overlay styles */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.3s ease-out;
        }

        .loading-container {
            text-align: center;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #FF9B3F;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        .loading-progress {
            width: 300px;
            margin: 1rem auto;
        }

        .progress-bar-container {
            width: 100%;
            height: 4px;
            background: rgba(255, 155, 63, 0.2);
            border-radius: 2px;
            overflow: hidden;
            margin: 0.5rem 0;
        }

        .progress-bar-fill {
            height: 100%;
            background: #FF9B3F;
            width: 0%;
            transition: width 0.3s ease;
        }

        .loading-status {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 0.5rem;
        }

        .loading-text {
            color: #FF9B3F;
            font-size: 1.1rem;
            font-weight: 500;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Page transition animation */
        .page-transition {
            animation: fadeOut 0.3s ease-out;
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        main {
            opacity: 0;
        }

        .level-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 2rem;
            position: relative;
        }

        .level-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .level-badge {
            width: 50px;
            height: 50px;
            background: #FF9B3F;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
        }

        .level-info {
            flex-grow: 1;
        }

        .level-title {
            font-size: 1.8rem;
            color: #333;
            margin-bottom: 0.5rem;
        }

        .level-progress {
            height: 6px;
            background: #f0f0f0;
            border-radius: 3px;
            overflow: hidden;
        }

        .level-progress-fill {
            height: 100%;
            background: #FF9B3F;
            transition: width 0.5s ease;
        }

        .next-level-btn {
            background: #FF9B3F;
            color: white;
            padding: 1rem 2rem;
            border-radius: 50px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 2rem auto;
            border: none;
        }

        .next-level-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 155, 63, 0.3);
        }

        .next-level-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .level-content {
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.5s ease;
        }

        .level-content.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .achievement-popup {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 1rem;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 1rem;
            animation: slideIn 0.5s ease;
            z-index: 1000;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Progress Tracking UI */
        .progress-sidebar {
            position: fixed;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: white;
            padding: 1rem;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            z-index: 100;
        }

        .progress-step {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #f0f0f0;
            margin: 1rem 0;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .progress-step.completed {
            background: #FF9B3F;
            color: white;
        }

        .progress-step.active {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 155, 63, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(255, 155, 63, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 155, 63, 0); }
        }

        /* Interactive Elements */
        .interactive-element {
            transform-origin: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .interactive-element:hover {
            transform: scale(1.1);
            filter: brightness(1.1);
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .progress-sidebar {
                bottom: 20px;
                top: auto;
                right: 50%;
                transform: translateX(50%);
                flex-direction: row;
                padding: 0.5rem;
            }

            .progress-step {
                margin: 0 0.5rem;
            }

            .level-content {
                padding: 1rem;
            }
        }

        /* Background Music Controls */
        .music-controls {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: white;
            padding: 0.5rem;
            border-radius: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            z-index: 100;
        }

        .volume-slider {
            width: 80px;
            height: 4px;
            -webkit-appearance: none;
            appearance: none;  /* Add this line */
            background: #f0f0f0;
            border-radius: 2px;
            outline: none;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 12px;
            height: 12px;
            background: #FF9B3F;
            border-radius: 50%;
            cursor: pointer;
        }
    </style>

    <!-- Add these in the <head> section, before your existing scripts -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/11.3.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.3.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.3.1/firebase-auth-compat.js"></script>

    <!-- Initialize Firebase -->
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDQw162F-ABofLGvXoZdqT54dxhRNBlH68",
            authDomain: "zynko-cd394.firebaseapp.com",
            projectId: "zynko-cd394",
            storageBucket: "zynko-cd394.firebasestorage.app",
            messagingSenderId: "551662653914",
            appId: "1:551662653914:web:501e9e792c7b471ada70e3",
            measurementId: "G-KSN55XH26B"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
    </script>

    <!-- Add this in the <head> section -->
    <link rel="icon" type="image/x-icon" href="/img/favicon.ico">
</head>
<body class="bg-gray-50">
    <!-- Update the loading overlay HTML -->
    <div class="loading-overlay" id="initialLoadingOverlay" style="display: flex;">
        <div class="loading-container">
            <div class="loading-spinner"></div>
            <div class="loading-progress">
                <div class="progress-bar-container">
                    <div class="progress-bar-fill" id="loadingProgressBar"></div>
                </div>
                <div class="loading-status" id="loadingStatus">Initializing...</div>
            </div>
            <div class="loading-text" id="loadingText">Preparing Sea Turtles...</div>
        </div>
    </div>

    <!-- Navigation Bar -->
    <nav class="bg-white shadow-md fixed w-full top-0 z-50">
        <div class="container mx-auto px-6 py-3 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <button onclick="window.history.back()" class="text-gray-600 hover:text-orange-500">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                </button>
                <h1 class="text-xl font-semibold text-gray-800">Sea Turtles</h1>
            </div>
            <div class="flex items-center gap-4">
                <button id="playAudioBtn" class="flex items-center gap-2 px-4 py-2 rounded-full bg-orange-500 text-white hover:bg-orange-600 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
                    </svg>
                    <span>Read Aloud</span>
                </button>
                <button id="toggleSound" class="flex items-center gap-2 px-4 py-2 rounded-full bg-gray-100 text-gray-600 hover:bg-gray-200 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
                    </svg>
                    <span>Sound: On</span>
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container mx-auto px-6 pt-24 pb-12">
        <!-- Progress Bar -->
        <div class="progress-bar mb-8">
            <div class="progress-fill" id="progressBar"></div>
        </div>

        <!-- Content Sections -->
        <div class="max-w-3xl mx-auto space-y-8">
            <!-- Section 1 -->
            <section class="section-content bg-white rounded-xl shadow-sm p-6">
                <div class="flex items-start gap-6">
                    <div class="prose prose-lg">
                        <p class="text-gray-700 leading-relaxed">
                            Most of us have seen a <span class="highlight-word">tortoise<span class="tooltip">A land-dwelling reptile with a hard shell</span></span> in a zoo or a reptile park. However, not many would have seen its <span class="highlight-word">marine<span class="tooltip">Found in or related to the sea</span></span> relative, the sea turtle. This is not surprising, since these reptiles spend almost their entire life in the sea.
                        </p>
                    </div>
                    <div class="w-48 flex-shrink-0">
                        <div id="turtleAnimation"></div>
                    </div>
                </div>
            </section>

            <!-- Section 2 -->
            <section class="section-content bg-white rounded-xl shadow-sm p-6">
                <div class="prose prose-lg">
                    <p class="text-gray-700 leading-relaxed">
                        There are seven <span class="highlight-word">species<span class="tooltip">A group of animals with common features</span></span> of marine or sea turtles in the world. Of them, five are found in India's <span class="highlight-word">coastal<span class="tooltip">Land by the edge of a sea</span></span> waters: the Olive Ridley, the Hawksbill, the Green Sea Turtle, the Loggerhead and the Leatherback.
                    </p>
                </div>
                <!-- Species Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mt-6">
                    <!-- Cards will be added dynamically via JavaScript -->
                </div>
            </section>

            <!-- Section 3 -->
            <section class="section-content bg-white rounded-xl shadow-sm p-6">
                <div class="prose prose-lg">
                    <p class="text-gray-700 leading-relaxed">
                        Compared to most tortoises, sea turtles are huge. Even the smallest species, the Olive Ridley, weighs up to 35 kg when fully grown. The largest of them all, the Leatherback, grows to a length of 2.2m and each could weigh as much as 700 kg!
                    </p>
                </div>
            </section>

            <!-- Section 4 -->
            <section class="section-content bg-white rounded-xl shadow-sm p-6">
                <div class="prose prose-lg">
                    <p class="text-gray-700 leading-relaxed">
                        Sea turtles live their life entirely in the oceans. But they still have a connection with land – they must come ashore to lay eggs. Today, four of the sea turtle species mentioned above have become extremely rare in India. The Olive Ridleys, however, are still commonly seen nesting on sandy beaches all along our coasts.
                    </p>
                </div>
            </section>

            <!-- Quiz Section -->
            <section class="section-content bg-white rounded-xl shadow-sm p-6">
                <div class="quiz-container">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-6">Knowledge Check</h2>
                    <div class="timer-container mb-4 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-orange-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <span id="timer" class="font-medium text-gray-600">Time remaining: 2:00</span>
                    </div>
                    <div id="quizContent" class="space-y-6">
                        <!-- Questions will be inserted here by JavaScript -->
                    </div>
                    <button id="submitQuiz" class="mt-6 px-6 py-3 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition-colors hidden">
                        Submit Answers
                    </button>
                </div>
            </section>

            <!-- Glossary Section -->
            <section class="section-content bg-white rounded-xl shadow-sm p-6">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6">Glossary</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="glossaryContent">
                    <!-- Glossary items will be added here by JavaScript -->
                </div>
            </section>

            <!-- Did You Know Section -->
            <section class="section-content bg-white rounded-xl shadow-sm p-6">
                <div class="flex items-start gap-6">
                    <div class="flex-grow">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-4 flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-orange-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                            </svg>
                            Did You Know? - Arribada
                        </h2>
                        <div class="prose prose-lg">
                            <p class="text-gray-700 leading-relaxed">
                                In most parts of the world, Olive Ridleys come ashore alone to lay their eggs. However, Odisha is one of the only three places in the world where a phenomenon known as 'mass nesting' or Arribada takes place.
                            </p>
                            <p class="text-gray-700 leading-relaxed mt-4">
                                On certain nights during the nesting season, thousands of female turtles come ashore simultaneously to lay their eggs on particular beaches.
                            </p>
                        </div>
                        <div id="mapContainer" class="mt-6 h-64 rounded-lg overflow-hidden">
                            <!-- Map will be added here -->
                        </div>
                    </div>
                    <div class="w-48 flex-shrink-0">
                        <div id="arribadaAnimation"></div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- Add this before the closing body tag -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <link href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>

    <script>
        // Initialize Lottie Animation
        const turtleAnimation = lottie.loadAnimation({
            container: document.getElementById('turtleAnimation'),
            renderer: 'svg',
            loop: true,
            autoplay: true,
            path: 'https://lottie.host/2a175f72-78ef-49b4-99e4-348f8a5be8d3/Y5WEwNO9Ux.json'  // Public Lottie URL
        });

        turtleAnimation.addEventListener('complete', () => {
            updateResourceStatus('animations');
        });

        // Text-to-Speech Implementation
        const playAudioBtn = document.getElementById('playAudioBtn');
        let isPlaying = false;
        let utterance = null;

        playAudioBtn.addEventListener('click', () => {
            if (isPlaying) {
                window.speechSynthesis.cancel();
                isPlaying = false;
                playAudioBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
                    </svg>
                    <span>Read Aloud</span>
                `;
            } else {
                const text = document.querySelector('.prose').textContent;
                utterance = new SpeechSynthesisUtterance(text);
                utterance.onend = () => {
                    isPlaying = false;
                    playAudioBtn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
                        </svg>
                        <span>Read Aloud</span>
                    `;
                };
                window.speechSynthesis.speak(utterance);
                isPlaying = true;
                playAudioBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z" />
                    </svg>
                    <span>Stop</span>
                `;
            }
        });

        // Progressive Content Reveal
        const sections = document.querySelectorAll('.section-content');
        let currentSection = 0;

        function showNextSection() {
            if (currentSection < sections.length) {
                sections[currentSection].classList.add('visible');
                updateProgress();
                currentSection++;
            }
        }

        function updateProgress() {
            const progress = (currentSection + 1) / sections.length * 100;
            document.getElementById('progressBar').style.width = `${progress}%`;
        }

        // Show first section immediately
        showNextSection();

        // Show subsequent sections on scroll
        window.addEventListener('scroll', () => {
            const scrollPosition = window.scrollY + window.innerHeight;
            sections.forEach((section, index) => {
                const sectionTop = section.offsetTop;
                if (scrollPosition > sectionTop + 100 && !section.classList.contains('visible')) {
                    showNextSection();
                }
            });
        });

        // Species Cards Data
        const speciesData = [
            {
                name: 'Olive Ridley',
                weight: '35 kg',
                image: '/img/olive-ridley.jpg'
            },
            {
                name: 'Hawksbill',
                image: '/img/hawksbill.jpg'
            },
            {
                name: 'Green Sea Turtle',
                image: '/img/green-sea-turtle.jpg'
            },
            {
                name: 'Loggerhead',
                image: '/img/loggerhead.jpg'
            },
            {
                name: 'Leatherback',
                weight: '700 kg',
                length: '2.2m',
                image: '/img/leatherback.jpg'
            }
        ];

        // Create Species Cards
        const speciesContainer = document.querySelector('.grid');
        speciesData.forEach(species => {
            const card = document.createElement('div');
            card.className = 'bg-gray-50 rounded-lg p-4 hover:shadow-md transition-shadow';
            card.innerHTML = `
                <img src="${species.image}" alt="${species.name}" class="w-full h-48 object-cover rounded-lg mb-4">
                <h3 class="font-semibold text-lg text-gray-800">${species.name}</h3>
                ${species.weight ? `<p class="text-gray-600">Weight: ${species.weight}</p>` : ''}
                ${species.length ? `<p class="text-gray-600">Length: ${species.length}</p>` : ''}
            `;
            speciesContainer.appendChild(card);
        });

        // Quiz Implementation
        const quizQuestions = [
            {
                text: "Turtles are different from tortoises.",
                correct: true
            },
            {
                text: "Turtles are sea animals.",
                correct: true
            },
            {
                text: "There are seven kinds of sea turtles in the world.",
                correct: true
            },
            {
                text: "Sea turtles are very small.",
                correct: false
            },
            {
                text: "Turtles come ashore to lay eggs.",
                correct: true
            },
            {
                text: "Sea turtles come to rest on land.",
                correct: false
            },
            {
                text: "Olive Ridleys are the only sea turtles seen on Indian shores.",
                correct: false
            }
        ];

        // Shuffle questions
        const shuffledQuestions = [...quizQuestions].sort(() => Math.random() - 0.5);

        // Create quiz elements
        const quizContent = document.getElementById('quizContent');
        shuffledQuestions.forEach((question, index) => {
            const questionElement = document.createElement('div');
            questionElement.className = 'question-item p-4 bg-gray-50 rounded-lg';
            questionElement.innerHTML = `
                <p class="text-gray-800 mb-3">${index + 1}. ${question.text}</p>
                <div class="flex gap-4">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="radio" name="q${index}" value="true" class="text-orange-500 focus:ring-orange-500">
                        <span>True</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="radio" name="q${index}" value="false" class="text-orange-500 focus:ring-orange-500">
                        <span>False</span>
                    </label>
                </div>
            `;
            quizContent.appendChild(questionElement);
        });

        // Show submit button
        document.getElementById('submitQuiz').classList.remove('hidden');

        // Quiz timer
        let timeLeft = 120; // 2 minutes
        const timerElement = document.getElementById('timer');
        
        const timerInterval = setInterval(() => {
            timeLeft--;
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            timerElement.textContent = `Time remaining: ${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                submitQuiz();
            }
        }, 1000);

        // Submit quiz handler
        document.getElementById('submitQuiz').addEventListener('click', submitQuiz);

        // Update the audio URLs to more reliable sources
        const correctSound = new Audio('/sounds/correct.mp3');  // Use local sound files
        const incorrectSound = new Audio('/sounds/incorrect.mp3');
        const successSound = new Audio('/sounds/success.mp3');

        // Add fallback sounds in case local files fail
        correctSound.onerror = () => {
            correctSound.src = 'https://www.soundjay.com/button/button-1.mp3';
        };
        incorrectSound.onerror = () => {
            incorrectSound.src = 'https://www.soundjay.com/button/button-2.mp3';
        };
        successSound.onerror = () => {
            successSound.src = 'https://www.soundjay.com/button/button-3.mp3';
        };

        // Fix the preloadSounds function
        function preloadSounds() {
            return new Promise((resolve) => {  // Add Promise wrapper
                const sounds = [correctSound, incorrectSound, successSound];
                let loadedCount = 0;

                sounds.forEach(sound => {
                    sound.addEventListener('canplaythrough', () => {
                        loadedCount++;
                        if (loadedCount === sounds.length) {
                            resolve();
                        }
                    });
                    sound.addEventListener('error', () => {
                        console.error('Error loading sound:', sound.src);
                        loadedCount++;
                        if (loadedCount === sounds.length) {
                            resolve();
                        }
                    });
                    sound.load();
                });
            });
        }

        // Call preload on window load
        window.addEventListener('load', preloadSounds);

        function submitQuiz() {
            clearInterval(timerInterval);
            let score = 0;
            let feedbackHtml = '';
            let soundPromises = [];
            
            // Collect answers and generate feedback
            shuffledQuestions.forEach((question, index) => {
                const selectedAnswer = document.querySelector(`input[name="q${index}"]:checked`)?.value === 'true';
                const isCorrect = selectedAnswer === question.correct;
                if (isCorrect) score++;
                
                // Create promise for playing sound
                const soundPromise = new Promise((resolve) => {
                    setTimeout(() => {
                        if (isCorrect) {
                            correctSound.currentTime = 0;
                            correctSound.play();
                        } else {
                            incorrectSound.currentTime = 0;
                            incorrectSound.play();
                        }
                        resolve();
                    }, index * 400); // Stagger sound effects
                });
                soundPromises.push(soundPromise);
                
                feedbackHtml += `
                    <div class="answer-feedback ${isCorrect ? 'correct' : 'incorrect'}" style="animation-delay: ${index * 0.1}s">
                        <div class="flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ${isCorrect ? 'text-green-500' : 'text-red-500'}" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${isCorrect ? 'M5 13l4 4L19 7' : 'M6 18L18 6M6 6l12 12'}" />
                            </svg>
                            <span class="font-medium">${question.text}</span>
                        </div>
                        <p class="ml-7 text-sm text-gray-600 mt-1">
                            ${isCorrect ? 'Correct!' : `Incorrect. The answer is ${question.correct ? 'True' : 'False'}`}
                        </p>
                    </div>
                `;
            });

            // Calculate percentage and show results
            const percentage = (score / shuffledQuestions.length) * 100;
            let animationPath, celebrateLevel;

            if (percentage === 100) {
                animationPath = 'https://assets10.lottiefiles.com/packages/lf20_trophy_celebration.json';
                celebrateLevel = 'perfect';
            } else if (percentage >= 70) {
                animationPath = 'https://assets9.lottiefiles.com/packages/lf20_jmihky5l.json';
                celebrateLevel = 'good';
            } else {
                animationPath = 'https://assets9.lottiefiles.com/packages/lf20_4qhqm09f.json';
                celebrateLevel = 'tryAgain';
            }

            // Play final success sound for good scores
            if (percentage >= 70) {
                setTimeout(() => {
                    successSound.currentTime = 0;
                    successSound.play();
                }, soundPromises.length * 400);
            }

            // Show results with animation after sound finish
            Promise.all(soundPromises).then(() => {
                Swal.fire({
                    title: 'Quiz Complete!',
                    html: `
                        <div class="quiz-feedback">
                            <div id="resultAnimation" class="feedback-icon"></div>
                            <div class="score-display text-4xl font-bold text-orange-500 mb-4">
                                ${score}/${shuffledQuestions.length}
                                <div class="text-lg font-normal text-gray-600">
                                    ${percentage}% Correct
                                </div>
                            </div>
                            <div class="mt-6 space-y-3">
                                ${feedbackHtml}
                            </div>
                        </div>
                    `,
                    showConfirmButton: true,
                    confirmButtonColor: '#FF9B3F',
                    confirmButtonText: 'Continue Learning',
                    allowOutsideClick: false,
                    didOpen: () => {
                        // Initialize result animation
                        lottie.loadAnimation({
                            container: document.getElementById('resultAnimation'),
                            renderer: 'svg',
                            loop: true,
                            autoplay: true,
                            path: animationPath
                        });

                        // Trigger confetti based on score
                        if (celebrateLevel === 'perfect') {
                            triggerPerfectScoreConfetti();
                        } else if (celebrateLevel === 'good') {
                            triggerGoodScoreConfetti();
                        }
                    }
                });
            });

            // Save score to Firebase
            if (firebase.auth().currentUser) {
                const userId = firebase.auth().currentUser.uid;
                db.collection('quizScores').add({
                    userId: userId,
                    quiz: 'Sea Turtles Unit 1',
                    score: score,
                    total: shuffledQuestions.length,
                    percentage: percentage,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
        }

        // Confetti animation functions
        function triggerPerfectScoreConfetti() {
            const duration = 3000;
            const animationEnd = Date.now() + duration;

            const interval = setInterval(function() {
                const timeLeft = animationEnd - Date.now();

                if (timeLeft <= 0) {
                    return clearInterval(interval);
                }

                confetti({
                    particleCount: 3,
                    angle: 60,
                    spread: 55,
                    origin: { x: 0 },
                    colors: ['#FF9B3F', '#FFB366', '#FFC080']
                });
                confetti({
                    particleCount: 3,
                    angle: 120,
                    spread: 55,
                    origin: { x: 1 },
                    colors: ['#FF9B3F', '#FFB366', '#FFC080']
                });
            }, 50);
        }

        function triggerGoodScoreConfetti() {
            confetti({
                particleCount: 100,
                spread: 70,
                origin: { y: 0.6 },
                colors: ['#FF9B3F', '#FFB366', '#FFC080']
            });
        }

        // Glossary Implementation
        const glossaryItems = [
            {
                word: 'The Olive Ridley',
                definition: 'A species of sea turtle found in warm waters of the Pacific and Indian oceans',
                example: 'The Olive Ridley is the smallest of all sea turtles.'
            },
            {
                word: 'marine',
                definition: 'Found in or related to the sea',
                example: 'Sea turtles are marine animals that spend most of their life in water.'
            },
            {
                word: 'species',
                definition: 'A group of animals with common features',
                example: 'There are seven species of sea turtles in the world.'
            },
            {
                word: 'coastal',
                definition: 'Land by the edge of a sea',
                example: 'Sea turtles nest on coastal beaches.'
            }
        ];

        const glossaryContent = document.getElementById('glossaryContent');
        glossaryItems.forEach(item => {
            const glossaryCard = document.createElement('div');
            glossaryCard.className = 'bg-gray-50 rounded-lg p-4';
            glossaryCard.innerHTML = `
                <div class="flex items-center gap-2 mb-2">
                    <h3 class="font-semibold text-gray-800">${item.word}</h3>
                    <button onclick="speakWord('${item.word}')" class="text-orange-500 hover:text-orange-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
                        </svg>
                    </button>
                </div>
                <p class="text-gray-600 mb-2">${item.definition}</p>
                <p class="text-gray-500 text-sm italic">${item.example}</p>
            `;
            glossaryContent.appendChild(glossaryCard);
        });

        function speakWord(word) {
            const utterance = new SpeechSynthesisUtterance(word);
            window.speechSynthesis.speak(utterance);
        }

        // Initialize map for Did You Know section
        const map = L.map('mapContainer').setView([20.2961, 85.8245], 6);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        L.marker([20.2961, 85.8245])
            .addTo(map)
            .bindPopup('Odisha - Famous for Arribada')
            .openPopup();

        // Initialize Arribada animation
        const arribadaAnimation = lottie.loadAnimation({
            container: document.getElementById('arribadaAnimation'),
            renderer: 'svg',
            loop: true,
            autoplay: true,
            path: 'https://assets5.lottiefiles.com/packages/lf20_beach_turtles.json'
        });

        // Add sound toggle functionality
        const toggleSoundBtn = document.getElementById('toggleSound');
        let soundEnabled = true;

        toggleSoundBtn.addEventListener('click', () => {
            soundEnabled = !soundEnabled;
            [correctSound, incorrectSound, successSound].forEach(sound => {
                sound.muted = !soundEnabled;
            });
            toggleSoundBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${soundEnabled ? 'M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z' : 'M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2'}" />
                </svg>
                <span>Sound: ${soundEnabled ? 'On' : 'Off'}</span>
            `;
        });

        // Loading states and progress handling
        const loadingStates = [
            { progress: 0, status: 'Initializing...', text: 'Preparing Sea Turtles...' },
            { progress: 20, status: 'Loading animations...', text: 'Getting turtles ready...' },
            { progress: 40, status: 'Loading content...', text: 'Reading stories...' },
            { progress: 60, status: 'Preparing quiz...', text: 'Setting up questions...' },
            { progress: 80, status: 'Loading media...', text: 'Almost there...' },
            { progress: 100, status: 'Complete!', text: 'Ready to explore!' }
        ];

        let currentStateIndex = 0;
        const progressBar = document.getElementById('loadingProgressBar');
        const statusText = document.getElementById('loadingStatus');
        const loadingText = document.getElementById('loadingText');

        function updateLoadingProgress() {
            if (currentStateIndex < loadingStates.length) {
                const state = loadingStates[currentStateIndex];
                progressBar.style.width = state.progress + '%';
                statusText.textContent = state.status;
                loadingText.textContent = state.text;
                currentStateIndex++;
                
                // Simulate loading time for each state
                setTimeout(updateLoadingProgress, 400);
            } else {
                // Fade out loading overlay when complete
                const loadingOverlay = document.getElementById('initialLoadingOverlay');
                setTimeout(() => {
                    loadingOverlay.style.opacity = '0';
                    setTimeout(() => {
                        loadingOverlay.style.display = 'none';
                    }, 300);
                }, 200);
            }
        }

        // Start loading sequence when document is ready
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize loading sequence
            setTimeout(updateLoadingProgress, 100);

            // Add entrance animation for main content
            const mainContent = document.querySelector('main');
            mainContent.style.opacity = '0';
            
            // Show main content after loading completes
            setTimeout(() => {
                mainContent.style.transition = 'opacity 0.5s ease-in';
                mainContent.style.opacity = '1';
            }, 2500); // Adjust timing based on loading sequence duration
        });

        // Add resource loading tracking
        const resources = {
            animations: false,
            images: false,
            sounds: false,
            content: false
        };

        function updateResourceStatus(resource) {
            resources[resource] = true;
            if (Object.values(resources).every(status => status)) {
                const loadingOverlay = document.getElementById('initialLoadingOverlay');
                loadingOverlay.style.opacity = '0';
                setTimeout(() => {
                    loadingOverlay.style.display = 'none';
                    // Show main content
                    const mainContent = document.querySelector('main');
                    mainContent.style.transition = 'opacity 0.5s ease-in';
                    mainContent.style.opacity = '1';
                }, 300);
            }
        }

        // Fix the image loading Promise
        document.addEventListener('DOMContentLoaded', () => {
            // Track content loading
            updateResourceStatus('content');
            
            // Track image loading
            const imagePromises = Array.from(document.images)
                .filter(img => !img.complete)
                .map(img => new Promise(resolve => {
                    img.onload = img.onerror = resolve;
                }));
            
            if (imagePromises.length > 0) {
                Promise.all(imagePromises).then(() => {
                    updateResourceStatus('images');
                });
            } else {
                updateResourceStatus('images');
            }

            // Track sound loading
            preloadSounds().then(() => {
                updateResourceStatus('sounds');
            });
        });

        // Track animation loading
        turtleAnimation.addEventListener('DOMLoaded', () => {
            updateResourceStatus('animations');
        });

        // Level-based structure with transitions and animations
        const levels = {
            1: {
                name: "Story Time",
                content: `
                    <div class="level-container">
                        <div class="prose-content">
                            <p class="text-gray-700 leading-relaxed animate-fade-in">
                                Most of us have seen a <span class="highlight-word">tortoise<span class="tooltip">A land-dwelling reptile with a hard shell</span></span> in a zoo or a reptile park...
                            </p>
                            <!-- Rest of the content -->
                        </div>
                        <div class="turtle-animation" id="readingTurtleAnimation"></div>
                        <button class="next-level-btn" onclick="completeLevel(1)">
                            I'm Ready for the Next Adventure!
                        </button>
                    </div>
                `
            },
            2: {
                name: "Visual Journey",
                content: `
                    <div class="level-container">
                        <div class="turtle-world-container" id="turtleWorld">
                            <!-- 3D/Lottie animations will be inserted here -->
                        </div>
                        <div class="interaction-guide">
                            Click and drag to explore the turtle's world!
                        </div>
                        <button class="next-level-btn" onclick="completeLevel(2)">
                            Ready for the Challenge!
                        </button>
                    </div>
                `
            },
            3: {
                name: "Knowledge Challenge",
                content: `
                    <div class="level-container">
                        <div class="game-quiz">
                            <!-- Interactive quiz with animations -->
                        </div>
                    </div>
                `
            },
            4: {
                name: "Word Explorer",
                content: `
                    <div class="level-container">
                        <div class="glossary-cards">
                            <!-- Interactive glossary cards -->
                        </div>
                    </div>
                `
            },
            5: {
                name: "Fun Facts",
                content: `
                    <div class="level-container">
                        <div class="did-you-know">
                            <!-- Arribada content with animations -->
                        </div>
                    </div>
                `
            }
        };

        // Level management system
        class LevelManager {
            constructor() {
                this.currentLevel = 1;
                this.maxLevel = Object.keys(levels).length;
                this.achievements = new Set();
                this.mainContent = document.querySelector('main');
                this.setupAudio();
            }

            setupAudio() {
                this.backgroundMusic = new Audio('/sounds/background-music.mp3');
                this.backgroundMusic.loop = true;
                this.backgroundMusic.volume = 0.3;
                this.levelUpSound = new Audio('/sounds/level-up.mp3');
                this.achievementSound = new Audio('/sounds/achievement.mp3');
            }

            async loadLevel(levelNumber) {
                const level = levels[levelNumber];
                if (!level) return;

                // Create level header
                const levelHeader = `
                    <div class="level-header">
                        <div class="level-badge">${levelNumber}</div>
                        <div class="level-info">
                            <h2 class="level-title">${level.name}</h2>
                            <div class="level-progress">
                                <div class="level-progress-fill" style="width: ${(levelNumber - 1) / this.maxLevel * 100}%"></div>
                            </div>
                        </div>
                    </div>
                `;

                // Update main content
                this.mainContent.innerHTML = levelHeader + level.content;
                
                // Initialize level-specific content
                await this.initializeLevelContent(levelNumber);
                
                // Show content with animation
                setTimeout(() => {
                    document.querySelector('.level-content').classList.add('visible');
                }, 100);
            }

            async initializeLevelContent(levelNumber) {
                switch(levelNumber) {
                    case 1:
                        await this.initializeStoryLevel();
                        break;
                    case 2:
                        await this.initializeVisualLevel();
                        break;
                    case 3:
                        await this.initializeQuizLevel();
                        break;
                    case 4:
                        await this.initializeGlossaryLevel();
                        break;
                    case 5:
                        await this.initializeFunFactsLevel();
                        break;
                }
            }

            async initializeStoryLevel() {
                // Initialize story level with animated text and tooltips
                const content = `
                    <div class="level-content prose-content p-6">
                        <div class="flex gap-8">
                            <div class="flex-1">
                                <p class="text-reveal">
                                    Most of us have seen a <span class="highlight-word">tortoise<span class="tooltip">A land-dwelling reptile with a hard shell</span></span> in a zoo or a reptile park. However, not many would have seen its <span class="highlight-word">marine<span class="tooltip">Found in or related to the sea</span></span> relative, the sea turtle.
                                </p>
                                <p class="text-reveal" style="animation-delay: 1s">
                                    There are seven <span class="highlight-word">species<span class="tooltip">A group of animals with common features</span></span> of marine or sea turtles in the world. Of them, five are found in India's <span class="highlight-word">coastal<span class="tooltip">Land by the edge of a sea</span></span> waters.
                                </p>
                            </div>
                            <div class="w-1/3">
                                <div id="storyTurtleAnimation"></div>
                            </div>
                        </div>
                        <button class="next-level-btn mt-8" onclick="levelManager.completeLevel(1)">
                            I understand, let's explore more! 
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"/>
                            </svg>
                        </button>
                    </div>
                `;
                
                this.mainContent.querySelector('.level-container').innerHTML += content;
                
                // Initialize story animations
                lottie.loadAnimation({
                    container: document.getElementById('storyTurtleAnimation'),
                    renderer: 'svg',
                    loop: true,
                    autoplay: true,
                    path: 'https://lottie.host/2a175f72-78ef-49b4-99e4-348f8a5be8d3/Y5WEwNO9Ux.json'
                });
            }

            async initializeVisualLevel() {
                const content = `
                    <div class="level-content">
                        <div class="turtle-world">
                            <div id="turtleSpecies" class="species-carousel"></div>
                            <div class="species-info bg-white p-6 rounded-lg shadow-lg mt-6">
                                <h3 class="text-xl font-bold mb-4">Meet the Sea Turtles</h3>
                                <div class="species-details"></div>
                            </div>
                        </div>
                        <button class="next-level-btn mt-8" onclick="levelManager.completeLevel(2)">
                            Ready for the Quiz Challenge!
                        </button>
                    </div>
                `;
                
                this.mainContent.querySelector('.level-container').innerHTML += content;
                
                // Initialize species carousel with interactive animations
                const species = [
                    { name: 'Olive Ridley', size: '35kg', description: 'The smallest sea turtle species' },
                    { name: 'Hawksbill', size: '80kg', description: 'Known for its beautiful shell' },
                    { name: 'Green Sea Turtle', size: '150kg', description: 'Named for the color of its fat' },
                    { name: 'Loggerhead', size: '200kg', description: 'Has a large head for crushing prey' },
                    { name: 'Leatherback', size: '700kg', description: 'The largest sea turtle species' }
                ];
                
                // Add interactive species cards
                const carousel = document.getElementById('turtleSpecies');
                species.forEach(s => this.createSpeciesCard(s, carousel));
            }

            async initializeQuizLevel() {
                const content = `
                    <div class="level-content quiz-container">
                        <div class="quiz-header">
                            <div class="quiz-progress">
                                <div class="progress-text">Question <span id="currentQuestion">1</span>/5</div>
                                <div class="timer">Time: <span id="quizTimer">60</span>s</div>
                            </div>
                        </div>
                        <div id="quizArea" class="quiz-area">
                            <!-- Questions will be inserted here -->
                        </div>
                    </div>
                `;
                
                this.mainContent.querySelector('.level-container').innerHTML += content;
                await this.startQuiz();
            }

            async initializeGlossaryLevel() {
                const content = `
                    <div class="level-content glossary-container">
                        <div class="glossary-grid">
                            <!-- Glossary cards with flip animation -->
                        </div>
                        <button class="next-level-btn mt-8" onclick="levelManager.completeLevel(4)">
                            Discover Fun Facts!
                        </button>
                    </div>
                `;
                
                this.mainContent.querySelector('.level-container').innerHTML += content;
                this.initializeGlossaryCards();
            }

            async initializeFunFactsLevel() {
                const content = `
                    <div class="level-content fun-facts-container">
                        <div class="arribada-animation" id="arribadaScene"></div>
                        <div class="fun-fact-card">
                            <h3>The Amazing Arribada</h3>
                            <p>Witness thousands of Olive Ridley turtles nesting together in this rare phenomenon!</p>
                        </div>
                        <button class="complete-course-btn" onclick="levelManager.completeCourse()">
                            Complete Course
                        </button>
                    </div>
                `;
                
                this.mainContent.querySelector('.level-container').innerHTML += content;
                this.initializeArribadaAnimation();
            }

            // Helper methods for level management
            async completeLevel(levelNumber) {
                // Play level completion sound
                this.levelUpSound.play();
                
                // Show achievement popup
                this.showAchievement(`Level ${levelNumber} Complete!`);
                
                // Save progress
                await this.saveProgress(levelNumber);
                
                // Load next level
                if (levelNumber < this.maxLevel) {
                    this.loadLevel(levelNumber + 1);
                }
            }

            showAchievement(message) {
                const popup = document.createElement('div');
                popup.className = 'achievement-popup';
                popup.innerHTML = `
                    <div class="achievement-icon">🏆</div>
                    <div class="achievement-text">
                        <h4>Achievement Unlocked!</h4>
                        <p>${message}</p>
                    </div>
                `;
                document.body.appendChild(popup);
                setTimeout(() => popup.remove(), 3000);
            }

            async startQuiz() {
                const questions = [
                    {
                        question: "What makes sea turtles unique from tortoises?",
                        options: [
                            "They spend almost their entire life in the sea",
                            "They are bigger in size",
                            "They have flippers",
                            "They lay more eggs"
                        ],
                        correct: 0,
                        animation: 'swimming_turtle'
                    },
                    {
                        question: "How many species of sea turtles are found in India's coastal waters?",
                        options: ["Three", "Four", "Five", "Seven"],
                        correct: 2,
                        animation: 'turtle_species'
                    },
                    // Add more questions...
                ];

                let currentQuestion = 0;
                const quizArea = document.getElementById('quizArea');

                const showQuestion = (index) => {
                    const question = questions[index];
                    quizArea.innerHTML = `
                        <div class="question-container">
                            <div class="question-animation" id="questionAnimation${index}"></div>
                            <h3 class="text-xl font-bold mb-4">${question.question}</h3>
                            <div class="options-grid">
                                ${question.options.map((option, i) => `
                                    <button class="option-btn" data-index="${i}">
                                        ${option}
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                    `;

                    // Load question-specific animation
                    lottie.loadAnimation({
                        container: document.getElementById(`questionAnimation${index}`),
                        renderer: 'svg',
                        loop: true,
                        autoplay: true,
                        path: `/animations/${question.animation}.json`
                    });

                    // Add click handlers to options
                    document.querySelectorAll('.option-btn').forEach(btn => {
                        btn.addEventListener('click', async (e) => {
                            const selectedIndex = parseInt(e.target.dataset.index);
                            const isCorrect = selectedIndex === question.correct;

                            // Play sound and show feedback
                            if (isCorrect) {
                                this.playCorrectSound();
                                await this.showFeedback('Correct! 🎉', 'success');
                            } else {
                                this.playIncorrectSound();
                                await this.showFeedback('Try again! 💪', 'error');
                                return;
                            }

                            // Move to next question or complete quiz
                            if (currentQuestion < questions.length - 1) {
                                currentQuestion++;
                                showQuestion(currentQuestion);
                            } else {
                                this.completeQuiz();
                            }
                        });
                    });
                };

                // Start with first question
                showQuestion(0);
            }

            async showFeedback(message, type) {
                return new Promise(resolve => {
                    const feedback = document.createElement('div');
                    feedback.className = `feedback-popup ${type}`;
                    feedback.innerHTML = message;
                    document.body.appendChild(feedback);

                    setTimeout(() => {
                        feedback.remove();
                        resolve();
                    }, 1500);
                });
            }

            async completeQuiz() {
                // Show celebration animation
                const celebration = lottie.loadAnimation({
                    container: document.getElementById('quizArea'),
                    renderer: 'svg',
                    loop: false,
                    autoplay: true,
                    path: '/animations/celebration.json'
                });

                // Play success sound
                this.playSuccessSound();

                // Show completion message
                await this.showFeedback('Quiz Complete! 🎉', 'success');

                // Add next level button
                document.getElementById('quizArea').innerHTML += `
                    <button class="next-level-btn mt-8" onclick="levelManager.completeLevel(3)">
                        Continue to Word Explorer!
                    </button>
                `;
            }

            createSpeciesCard(species, container) {
                const card = document.createElement('div');
                card.className = 'species-card';
                card.innerHTML = `
                    <div class="species-animation" id="${species.name.toLowerCase()}Animation"></div>
                    <h3>${species.name}</h3>
                    <div class="species-details">
                        <p>Weight: ${species.size}</p>
                        <p>${species.description}</p>
                    </div>
                `;
                container.appendChild(card);

                // Add hover animation
                card.addEventListener('mouseenter', () => {
                    card.style.transform = 'scale(1.05)';
                });
                card.addEventListener('mouseleave', () => {
                    card.style.transform = 'scale(1)';
                });

                // Load species-specific animation
                lottie.loadAnimation({
                    container: card.querySelector('.species-animation'),
                    renderer: 'svg',
                    loop: true,
                    autoplay: true,
                    path: `/animations/${species.name.toLowerCase()}.json`
                });
            }

            // Sound methods
            playCorrectSound() {
                const sound = new Audio('/sounds/correct.mp3');
                sound.volume = 0.5;
                sound.play();
            }

            playIncorrectSound() {
                const sound = new Audio('/sounds/incorrect.mp3');
                sound.volume = 0.4;
                sound.play();
            }

            playSuccessSound() {
                const sound = new Audio('/sounds/success.mp3');
                sound.volume = 0.6;
                sound.play();
            }

            async initializeGlossaryCards() {
                const glossaryItems = [
                    {
                        word: 'Tortoise',
                        definition: 'A land-dwelling reptile with a hard shell',
                        example: 'Tortoises are found in zoos and reptile parks.',
                        animation: 'tortoise'
                    },
                    {
                        word: 'Marine',
                        definition: 'Found in or related to the sea',
                        example: 'Sea turtles are marine animals.',
                        animation: 'waves'
                    },
                    {
                        word: 'Species',
                        definition: 'A group of animals with common features',
                        example: 'There are seven species of sea turtles.',
                        animation: 'diversity'
                    },
                    // Add more glossary items...
                ];

                const glossaryGrid = document.querySelector('.glossary-grid');
                glossaryItems.forEach(item => this.createGlossaryCard(item, glossaryGrid));
            }

            createGlossaryCard(item, container) {
                const card = document.createElement('div');
                card.className = 'glossary-card';
                card.innerHTML = `
                    <div class="card-inner">
                        <div class="card-front">
                            <div class="word-animation" id="${item.word.toLowerCase()}Animation"></div>
                            <h3 class="word-title">${item.word}</h3>
                            <button class="flip-btn">Learn More</button>
                        </div>
                        <div class="card-back">
                            <h4>Definition:</h4>
                            <p>${item.definition}</p>
                            <h4>Example:</h4>
                            <p>${item.example}</p>
                            <button class="flip-btn">Back</button>
                        </div>
                    </div>
                `;
                container.appendChild(card);

                // Add flip animation
                const flipBtns = card.querySelectorAll('.flip-btn');
                flipBtns.forEach(btn => {
                    btn.addEventListener('click', () => {
                        card.querySelector('.card-inner').classList.toggle('flipped');
                        this.playCardFlipSound();
                    });
                });

                // Load word-specific animation
                lottie.loadAnimation({
                    container: card.querySelector('.word-animation'),
                    renderer: 'svg',
                    loop: true,
                    autoplay: true,
                    path: `/animations/${item.animation}.json`
                });
            }

            async initializeArribadaAnimation() {
                const scene = document.getElementById('arribadaScene');
                
                // Load interactive arribada animation
                const animation = lottie.loadAnimation({
                    container: scene,
                    renderer: 'svg',
                    loop: true,
                    autoplay: true,
                    path: '/animations/arribada.json'
                });

                // Add interactive elements
                const funFacts = [
                    "Thousands of turtles nest simultaneously during Arribada",
                    "This phenomenon occurs in only a few places worldwide",
                    "Each turtle can lay around 100 eggs",
                    "The nesting process takes about 45 minutes"
                ];

                const factContainer = document.createElement('div');
                factContainer.className = 'fun-facts-slider';
                
                funFacts.forEach((fact, index) => {
                    const factElement = document.createElement('div');
                    factElement.className = 'fact-item';
                    factElement.innerHTML = `
                        <div class="fact-number">${index + 1}</div>
                        <p>${fact}</p>
                    `;
                    factContainer.appendChild(factElement);
                });

                scene.appendChild(factContainer);
            }

            // Achievement System
            async saveProgress(levelNumber) {
                if (firebase.auth().currentUser) {
                    const userId = firebase.auth().currentUser.uid;
                    try {
                        await db.collection('userProgress').doc(userId).set({
                            lastCompletedLevel: levelNumber,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        }, { merge: true });

                        // Check and award achievements
                        await this.checkAchievements(levelNumber);
                    } catch (error) {
                        console.error('Error saving progress:', error);
                    }
                }
            }

            async checkAchievements(levelNumber) {
                const achievements = {
                    1: { name: 'Story Explorer', icon: '📚', description: 'Completed the story section' },
                    2: { name: 'Visual Learner', icon: '👀', description: 'Explored all turtle species' },
                    3: { name: 'Quiz Master', icon: '🎯', description: 'Completed the quiz challenge' },
                    4: { name: 'Word Wizard', icon: '📖', description: 'Mastered the glossary' },
                    5: { name: 'Turtle Expert', icon: '🐢', description: 'Completed all levels' }
                };

                if (achievements[levelNumber] && !this.achievements.has(levelNumber)) {
                    this.achievements.add(levelNumber);
                    this.showAchievementUnlocked(achievements[levelNumber]);
                    this.playAchievementSound();
                }
            }

            showAchievementUnlocked(achievement) {
                const popup = document.createElement('div');
                popup.className = 'achievement-unlock-popup';
                popup.innerHTML = `
                    <div class="achievement-content">
                        <div class="achievement-icon">${achievement.icon}</div>
                        <div class="achievement-details">
                            <h3>${achievement.name}</h3>
                            <p>${achievement.description}</p>
                        </div>
                    </div>
                `;
                document.body.appendChild(popup);

                // Add celebration effect
                confetti({
                    particleCount: 100,
                    spread: 70,
                    origin: { y: 0.6 }
                });

                setTimeout(() => {
                    popup.remove();
                }, 3000);
            }

            playCardFlipSound() {
                const flipSound = new Audio('/sounds/card-flip.mp3');
                flipSound.volume = 0.3;
                flipSound.play();
            }

            playAchievementSound() {
                const achievementSound = new Audio('/sounds/achievement.mp3');
                achievementSound.volume = 0.5;
                achievementSound.play();
            }

            initializeProgressUI() {
                const progressSidebar = document.createElement('div');
                progressSidebar.className = 'progress-sidebar';
                
                for (let i = 1; i <= this.maxLevel; i++) {
                    const step = document.createElement('div');
                    step.className = `progress-step ${i === this.currentLevel ? 'active' : ''} ${i < this.currentLevel ? 'completed' : ''}`;
                    step.innerHTML = `<span>${i}</span>`;
                    step.addEventListener('click', () => this.handleProgressClick(i));
                    progressSidebar.appendChild(step);
                }
                
                document.body.appendChild(progressSidebar);
            }

            handleProgressClick(level) {
                if (level <= this.currentLevel) {
                    this.loadLevel(level);
                }
            }

            initializeBackgroundMusic() {
                const musicControls = document.createElement('div');
                musicControls.className = 'music-controls';
                musicControls.innerHTML = `
                    <button id="toggleMusic" class="music-btn">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"/>
                        </svg>
                    </button>
                    <input type="range" class="volume-slider" min="0" max="100" value="30">
                `;
                
                document.body.appendChild(musicControls);
                
                // Initialize music controls
                const toggleBtn = document.getElementById('toggleMusic');
                const volumeSlider = document.querySelector('.volume-slider');
                
                toggleBtn.addEventListener('click', () => {
                    if (this.backgroundMusic.paused) {
                        this.backgroundMusic.play();
                        toggleBtn.classList.add('playing');
                    } else {
                        this.backgroundMusic.pause();
                        toggleBtn.classList.remove('playing');
                    }
                });
                
                volumeSlider.addEventListener('input', (e) => {
                    this.backgroundMusic.volume = e.target.value / 100;
                });
            }

            addInteractiveElements() {
                document.querySelectorAll('.interactive-element').forEach(element => {
                    element.addEventListener('mouseenter', () => {
                        this.playHoverSound();
                    });
                    
                    element.addEventListener('click', () => {
                        this.playClickSound();
                    });
                });
            }

            playHoverSound() {
                const hoverSound = new Audio('/sounds/hover.mp3');
                hoverSound.volume = 0.2;
                hoverSound.play();
            }

            playClickSound() {
                const clickSound = new Audio('/sounds/click.mp3');
                clickSound.volume = 0.3;
                clickSound.play();
            }
        }
    </script>
</body>
</html> 
